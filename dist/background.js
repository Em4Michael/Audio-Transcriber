(()=>{let e,r,o;console.log("Background script loaded"),console.log("Is service worker?",self instanceof ServiceWorkerGlobalScope);let t="ws://localhost:8080",s=[],c=0,n=!1,a=!1,i=!1;async function l(e,o){try{let t=await chrome.tabs.get(e);if(t.url.startsWith("chrome://")||t.url.startsWith("about:")){console.error("Cannot capture audio from system pages"),o({success:!1,error:"Cannot capture system pages"});return}r=e,n=!0,s=[],chrome.tabCapture.getMediaStreamId({consumerTabId:e},r=>{if(chrome.runtime.lastError||!r){console.error("getMediaStreamId error:",chrome.runtime.lastError?.message||"No stream ID"),o({success:!1,error:chrome.runtime.lastError?.message||"Failed to get stream ID"}),n=!1;return}chrome.scripting.executeScript({target:{tabId:e},files:["content.js"]},()=>{if(chrome.runtime.lastError){console.error("Script injection error:",chrome.runtime.lastError.message),o({success:!1,error:chrome.runtime.lastError.message}),n=!1;return}chrome.tabs.sendMessage(e,{action:"startRecording",streamId:r},e=>{if(chrome.runtime.lastError||!e||!e.success){console.error("Content script error:",chrome.runtime.lastError?.message||e?.error),o({success:!1,error:chrome.runtime.lastError?.message||e?.error||"Failed to start recording"}),n=!1;return}console.log("Recording initiated in content script"),o({success:!0})})})})}catch(e){console.error("Recording setup error:",e),o({success:!1,error:e.message})}}async function m(){if(console.log("Processing transcription..."),s.length>0){let e=new Blob(s,{type:"audio/webm;codecs=opus"});if(console.log("Audio blob size:",e.size),e.size>1e3)try{let r=await u(e);o.readyState===WebSocket.OPEN&&(o.send(JSON.stringify({type:"transcription",text:r})),console.log("Transcription sent:",r)),chrome.storage.local.set({transcription:r})}catch(e){console.error("Transcription failed:",e),chrome.storage.local.set({transcription:"Error: Transcription failed"})}else console.log("Blob too small, skipping transcription:",e.size),chrome.storage.local.set({transcription:"Skipped: Audio too short"});s=[]}n&&(await new Promise(e=>{chrome.tabs.sendMessage(r,{action:"stopRecording"},r=>{chrome.runtime.lastError&&(console.error("Stop for restart error:",chrome.runtime.lastError.message),n=!1),setTimeout(e,100)})}),n&&chrome.tabCapture.getMediaStreamId({consumerTabId:r},e=>{if(chrome.runtime.lastError||!e){console.error("Restart getMediaStreamId error:",chrome.runtime.lastError?.message||"No stream ID"),n=!1;return}chrome.tabs.sendMessage(r,{action:"startRecording",streamId:e},e=>{if(chrome.runtime.lastError||!e||!e.success){console.error("Restart content script error:",chrome.runtime.lastError?.message||e?.error),n=!1;return}console.log("Recording restarted in content script")})}))}async function u(e){let r=new FormData;r.append("file",e,"audio.webm"),r.append("model","whisper-1"),r.append("language","en");let o=await fetch("https://api.openai.com/v1/audio/transcriptions",{method:"POST",headers:{Authorization:"Bearer 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"},body:r});if(!o.ok){let e=await o.text();throw Error(`Transcription failed: ${e}`)}let t=await o.json();return console.log("Transcription result:",t.text),t.text}(o=new WebSocket(t)).onopen=()=>console.log("WebSocket connected to",t),o.onerror=e=>console.error("WebSocket error:",e),o.onclose=()=>console.log("WebSocket disconnected"),chrome.runtime.onMessage.addListener((o,t,u)=>{if(console.log("Message received:",o),"startRecording"===o.action)return n?u({success:!1,error:"Already recording"}):chrome.tabs.query({active:!0,currentWindow:!0},e=>{l(e[0].id,u)}),!0;if("stopRecording"===o.action)return!function(e){if(!n){e({success:!0});return}chrome.tabs.sendMessage(r,{action:"stopRecording"},r=>{chrome.runtime.lastError&&console.error("Stop message error:",chrome.runtime.lastError.message),n=!1,s=[],chrome.storage.local.set({recording:!1}),console.log("Recording stopped"),e({success:!0})})}(u),!0;if("appendAudioChunk"===o.action){let r=new Blob([new Uint8Array(o.chunk)],{type:"audio/webm;codecs=opus"});s.push(r),function(r){r>.07&&!a?(a=!0,c=Date.now(),clearTimeout(e),e=null,console.log("Speech detected, lastAudioTime:",c)):r<=.07&&a&&(a=!1,console.log("Silence detected after speech")),r<=.07&&n&&s.length>0&&!i&&!e?(console.log("Starting silence timer..."),e=setTimeout(async()=>{Date.now()-c>=2e3&&(console.log("Prolonged silence detected, processing..."),i=!0,await m(),i=!1),e=null},2e3)):r>.07&&e&&(console.log("Sound detected, clearing silence timer"),clearTimeout(e),e=null)}(o.audioLevel),u({success:!0})}})})();